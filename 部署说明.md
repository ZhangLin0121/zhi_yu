# æˆ¿é—´ç®¡ç†ç³»ç»Ÿéƒ¨ç½²è¯´æ˜

## ğŸ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†æˆ¿é—´ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´éƒ¨ç½²æŒ‡å—ï¼ŒåŒ…å«å¤šç§éƒ¨ç½²æ–¹å¼ä»¥é€‚åº”ä¸åŒçš„æœåŠ¡å™¨ç¯å¢ƒã€‚

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu/CentOS/Debian)
- **Python**: 3.7+
- **Git**: ç”¨äºä»£ç ç®¡ç†
- **ç½‘ç»œ**: éœ€è¦è®¿é—®å¤–éƒ¨API (platform.inzhiyu.com)
- **ç«¯å£**: 5001 (å¯åœ¨config.pyä¸­ä¿®æ”¹)

## ğŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
curl -sSL https://raw.githubusercontent.com/ZhangLin0121/zhi_yu/main/simple_deploy.sh | bash
```

**ä¼˜ç‚¹**ï¼š
- æœ€ç®€å•ï¼Œä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰éƒ¨ç½²
- è‡ªåŠ¨å¤„ç†ä¾èµ–å®‰è£…å’Œè®¤è¯åˆå§‹åŒ–
- åŒ…å«å®Œæ•´çš„æµ‹è¯•éªŒè¯

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

1. **å…‹éš†ä»£ç **
```bash
sudo mkdir -p /opt/room-management
cd /opt/room-management
git clone https://github.com/ZhangLin0121/zhi_yu.git .
```

2. **å®‰è£…ä¾èµ–**
```bash
pip3 install -r requirements.txt
```

3. **åˆå§‹åŒ–è®¤è¯**
```bash
python3 -c "
from auth_manager import update_auth_info
auth = {
    '_ams_token': 'web_cdpi6hgs9ez80cb8jit3emwv2wuh4uo5',
    '_common_token': 'web_cdpi6hgs9ez80cb8jit3emwv2wuh4uo5',
    'HWWAFSESID': '13733731437c2a43e3',
    'HWWAFSESTIME': '1751861002097'
}
update_auth_info(auth)
"
```

4. **å¯åŠ¨åº”ç”¨**
```bash
nohup python3 app.py > app.log 2>&1 &
echo $! > app.pid
```

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬

ä¸‹è½½å¹¶æ‰§è¡Œå®Œæ•´çš„éƒ¨ç½²è„šæœ¬ï¼š

```bash
wget https://raw.githubusercontent.com/ZhangLin0121/zhi_yu/main/server_deploy_manual.sh
chmod +x server_deploy_manual.sh
./server_deploy_manual.sh
```

## ğŸ”§ åº”ç”¨ç®¡ç†

### å¯åŠ¨åº”ç”¨
```bash
cd /opt/room-management
nohup python3 app.py > app.log 2>&1 &
echo $! > app.pid
```

### åœæ­¢åº”ç”¨
```bash
cd /opt/room-management
if [ -f app.pid ]; then
    kill $(cat app.pid)
    rm app.pid
else
    pkill -f "python3 app.py"
fi
```

### æŸ¥çœ‹çŠ¶æ€
```bash
cd /opt/room-management
if [ -f app.pid ]; then
    PID=$(cat app.pid)
    if kill -0 $PID 2>/dev/null; then
        echo "åº”ç”¨æ­£åœ¨è¿è¡Œï¼ŒPID: $PID"
    else
        echo "åº”ç”¨æœªè¿è¡Œ"
    fi
else
    echo "åº”ç”¨æœªè¿è¡Œ"
fi
```

### æŸ¥çœ‹æ—¥å¿—
```bash
cd /opt/room-management
tail -f app.log
```

## ğŸ§ª éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥APIçŠ¶æ€
```bash
curl -s "http://localhost:5001/api/status" | python3 -m json.tool
```

æœŸæœ›è¾“å‡ºï¼š
```json
{
  "status": "healthy",
  "total_rooms": 238,
  "timestamp": "2025-07-07T12:00:00.000000",
  "last_update": "2025-07-07T12:00:00.000000"
}
```

### 2. æ£€æŸ¥æˆ¿é—´æ•°æ®
```bash
curl -s "http://localhost:5001/api/rooms" | python3 -c "
import json, sys
data = json.load(sys.stdin)
print(f'æ€»æˆ¿é—´æ•°: {data.get(\"total_rooms\", 0)}')
floors = data.get('floors', {})
total_occupied = sum(len([r for r in rooms if r.get('tenants')]) for rooms in floors.values())
print(f'å·²å…¥ä½: {total_occupied}')
print(f'å…¥ä½ç‡: {total_occupied/data.get(\"total_rooms\", 1)*100:.1f}%')
"
```

### 3. è®¿é—®Webç•Œé¢
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://æœåŠ¡å™¨IP:5001`

## ğŸ” è®¤è¯ç®¡ç†

### æŸ¥çœ‹å½“å‰è®¤è¯ä¿¡æ¯
```bash
cd /opt/room-management
python3 -c "
from auth_manager import get_fresh_auth_info
auth = get_fresh_auth_info()
if auth:
    print('è®¤è¯ä¿¡æ¯æœ‰æ•ˆ')
    print(f'Token: {auth.get(\"_ams_token\", \"æ— \")[:20]}...')
else:
    print('è®¤è¯ä¿¡æ¯æ— æ•ˆæˆ–è¿‡æœŸ')
"
```

### æ›´æ–°è®¤è¯ä¿¡æ¯
```bash
cd /opt/room-management
python3 -c "
from auth_manager import update_auth_info
# åœ¨è¿™é‡Œæ›´æ–°æ–°çš„è®¤è¯ä¿¡æ¯
auth = {
    '_ams_token': 'æ–°çš„token',
    '_common_token': 'æ–°çš„token',
    'HWWAFSESID': 'æ–°çš„session_id',
    'HWWAFSESTIME': 'æ–°çš„æ—¶é—´æˆ³'
}
update_auth_info(auth)
print('è®¤è¯ä¿¡æ¯å·²æ›´æ–°')
"
```

## ğŸ”„ æ›´æ–°åº”ç”¨

### å¿«é€Ÿæ›´æ–°
```bash
cd /opt/room-management
git pull origin main
pip3 install -r requirements.txt
# é‡å¯åº”ç”¨
kill $(cat app.pid) 2>/dev/null || true
nohup python3 app.py > app.log 2>&1 &
echo $! > app.pid
```

### ä½¿ç”¨æ›´æ–°è„šæœ¬
å¦‚æœé¡¹ç›®ä¸­æœ‰`update_server.sh`è„šæœ¬ï¼š
```bash
cd /opt/room-management
./update_server.sh
```

## ğŸŒ è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **ä¸»é¡µ**: http://æœåŠ¡å™¨IP:5001
- **APIçŠ¶æ€**: http://æœåŠ¡å™¨IP:5001/api/status
- **æˆ¿é—´æ•°æ®**: http://æœåŠ¡å™¨IP:5001/api/rooms
- **è®¤è¯æ›´æ–°**: http://æœåŠ¡å™¨IP:5001/api/auth/update (POST)

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. åº”ç”¨å¯åŠ¨å¤±è´¥
```bash
cd /opt/room-management
tail -20 app.log
```

### 2. è®¤è¯å¤±è´¥
æ£€æŸ¥è®¤è¯ä¿¡æ¯æ˜¯å¦è¿‡æœŸï¼š
```bash
python3 -c "
from auth_manager import get_fresh_auth_info
auth = get_fresh_auth_info()
if not auth:
    print('è®¤è¯ä¿¡æ¯è¿‡æœŸï¼Œéœ€è¦æ›´æ–°')
"
```

### 3. æ•°æ®è·å–å¤±è´¥
æµ‹è¯•APIè¿æ¥ï¼š
```bash
python3 -c "
from api_client import RoomsDataManager
manager = RoomsDataManager()
try:
    data = manager.generate_complete_layout()
    print('æ•°æ®è·å–æˆåŠŸ')
except Exception as e:
    print(f'æ•°æ®è·å–å¤±è´¥: {e}')
"
```

### 4. ç«¯å£å ç”¨
æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µï¼š
```bash
netstat -tulpn | grep 5001
```

å¦‚æœç«¯å£è¢«å ç”¨ï¼Œå¯ä»¥åœ¨`config.py`ä¸­ä¿®æ”¹ç«¯å£å·ã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡å™¨ç½‘ç»œè¿æ¥
2. Pythonç‰ˆæœ¬å’Œä¾èµ–
3. è®¤è¯ä¿¡æ¯æœ‰æ•ˆæ€§
4. é˜²ç«å¢™è®¾ç½®
5. æ—¥å¿—æ–‡ä»¶å†…å®¹

## ğŸ”„ ç³»ç»Ÿæ¶æ„

```
æˆ¿é—´ç®¡ç†ç³»ç»Ÿ
â”œâ”€â”€ app.py              # Flaskä¸»åº”ç”¨
â”œâ”€â”€ api_client.py       # APIå®¢æˆ·ç«¯
â”œâ”€â”€ auth_manager.py     # è®¤è¯ç®¡ç†
â”œâ”€â”€ config.py          # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt   # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ static/           # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ css/
â”‚   â””â”€â”€ js/
â””â”€â”€ templates/        # HTMLæ¨¡æ¿
    â””â”€â”€ index.html
```

ç³»ç»Ÿé€šè¿‡æ™ºèƒ½è®¤è¯ç®¡ç†è‡ªåŠ¨ç»´æŠ¤APIè®¿é—®æƒé™ï¼Œç¡®ä¿æ•°æ®è·å–çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚ 