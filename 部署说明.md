# 房间管理系统部署说明

## 🎯 部署概述

本文档提供了房间管理系统的完整部署指南，包含多种部署方式以适应不同的服务器环境。

## 📋 系统要求

- **操作系统**: Linux (Ubuntu/CentOS/Debian)
- **Python**: 3.7+
- **Git**: 用于代码管理
- **网络**: 需要访问外部API (platform.inzhiyu.com)
- **端口**: 5001 (可在config.py中修改)

## 🚀 部署方式

### 方式一：一键部署（推荐）

在服务器上执行以下命令：

```bash
curl -sSL https://raw.githubusercontent.com/ZhangLin0121/zhi_yu/main/simple_deploy.sh | bash
```

**优点**：
- 最简单，一条命令完成所有部署
- 自动处理依赖安装和认证初始化
- 包含完整的测试验证

### 方式二：手动部署

1. **克隆代码**
```bash
sudo mkdir -p /opt/room-management
cd /opt/room-management
git clone https://github.com/ZhangLin0121/zhi_yu.git .
```

2. **安装依赖**
```bash
pip3 install -r requirements.txt
```

3. **初始化认证**
```bash
python3 -c "
from auth_manager import update_auth_info
auth = {
    '_ams_token': 'web_cdpi6hgs9ez80cb8jit3emwv2wuh4uo5',
    '_common_token': 'web_cdpi6hgs9ez80cb8jit3emwv2wuh4uo5',
    'HWWAFSESID': '13733731437c2a43e3',
    'HWWAFSESTIME': '1751861002097'
}
update_auth_info(auth)
"
```

4. **启动应用**
```bash
nohup python3 app.py > app.log 2>&1 &
echo $! > app.pid
```

### 方式三：使用部署脚本

下载并执行完整的部署脚本：

```bash
wget https://raw.githubusercontent.com/ZhangLin0121/zhi_yu/main/server_deploy_manual.sh
chmod +x server_deploy_manual.sh
./server_deploy_manual.sh
```

## 🔧 应用管理

### 启动应用
```bash
cd /opt/room-management
nohup python3 app.py > app.log 2>&1 &
echo $! > app.pid
```

### 停止应用
```bash
cd /opt/room-management
if [ -f app.pid ]; then
    kill $(cat app.pid)
    rm app.pid
else
    pkill -f "python3 app.py"
fi
```

### 查看状态
```bash
cd /opt/room-management
if [ -f app.pid ]; then
    PID=$(cat app.pid)
    if kill -0 $PID 2>/dev/null; then
        echo "应用正在运行，PID: $PID"
    else
        echo "应用未运行"
    fi
else
    echo "应用未运行"
fi
```

### 查看日志
```bash
cd /opt/room-management
tail -f app.log
```

## 🧪 验证部署

### 1. 检查API状态
```bash
curl -s "http://localhost:5001/api/status" | python3 -m json.tool
```

期望输出：
```json
{
  "status": "healthy",
  "total_rooms": 238,
  "timestamp": "2025-07-07T12:00:00.000000",
  "last_update": "2025-07-07T12:00:00.000000"
}
```

### 2. 检查房间数据
```bash
curl -s "http://localhost:5001/api/rooms" | python3 -c "
import json, sys
data = json.load(sys.stdin)
print(f'总房间数: {data.get(\"total_rooms\", 0)}')
floors = data.get('floors', {})
total_occupied = sum(len([r for r in rooms if r.get('tenants')]) for rooms in floors.values())
print(f'已入住: {total_occupied}')
print(f'入住率: {total_occupied/data.get(\"total_rooms\", 1)*100:.1f}%')
"
```

### 3. 访问Web界面
打开浏览器访问：`http://服务器IP:5001`

## 🔐 认证管理

### 查看当前认证信息
```bash
cd /opt/room-management
python3 -c "
from auth_manager import get_fresh_auth_info
auth = get_fresh_auth_info()
if auth:
    print('认证信息有效')
    print(f'Token: {auth.get(\"_ams_token\", \"无\")[:20]}...')
else:
    print('认证信息无效或过期')
"
```

### 更新认证信息
```bash
cd /opt/room-management
python3 -c "
from auth_manager import update_auth_info
# 在这里更新新的认证信息
auth = {
    '_ams_token': '新的token',
    '_common_token': '新的token',
    'HWWAFSESID': '新的session_id',
    'HWWAFSESTIME': '新的时间戳'
}
update_auth_info(auth)
print('认证信息已更新')
"
```

## 🔄 更新应用

### 快速更新
```bash
cd /opt/room-management
git pull origin main
pip3 install -r requirements.txt
# 重启应用
kill $(cat app.pid) 2>/dev/null || true
nohup python3 app.py > app.log 2>&1 &
echo $! > app.pid
```

### 使用更新脚本
如果项目中有`update_server.sh`脚本：
```bash
cd /opt/room-management
./update_server.sh
```

## 🌐 访问地址

部署完成后，可以通过以下地址访问：

- **主页**: http://服务器IP:5001
- **API状态**: http://服务器IP:5001/api/status
- **房间数据**: http://服务器IP:5001/api/rooms
- **认证更新**: http://服务器IP:5001/api/auth/update (POST)

## 🛠️ 故障排除

### 1. 应用启动失败
```bash
cd /opt/room-management
tail -20 app.log
```

### 2. 认证失败
检查认证信息是否过期：
```bash
python3 -c "
from auth_manager import get_fresh_auth_info
auth = get_fresh_auth_info()
if not auth:
    print('认证信息过期，需要更新')
"
```

### 3. 数据获取失败
测试API连接：
```bash
python3 -c "
from api_client import RoomsDataManager
manager = RoomsDataManager()
try:
    data = manager.generate_complete_layout()
    print('数据获取成功')
except Exception as e:
    print(f'数据获取失败: {e}')
"
```

### 4. 端口占用
检查端口使用情况：
```bash
netstat -tulpn | grep 5001
```

如果端口被占用，可以在`config.py`中修改端口号。

## 📞 技术支持

如果遇到问题，请检查：
1. 服务器网络连接
2. Python版本和依赖
3. 认证信息有效性
4. 防火墙设置
5. 日志文件内容

## 🔄 系统架构

```
房间管理系统
├── app.py              # Flask主应用
├── api_client.py       # API客户端
├── auth_manager.py     # 认证管理
├── config.py          # 配置文件
├── requirements.txt   # 依赖列表
├── static/           # 静态文件
│   ├── css/
│   └── js/
└── templates/        # HTML模板
    └── index.html
```

系统通过智能认证管理自动维护API访问权限，确保数据获取的稳定性和安全性。 