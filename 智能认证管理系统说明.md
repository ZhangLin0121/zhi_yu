# 智能认证管理系统说明

## 系统概述

本系统实现了智能的API认证管理，能够自动检测认证失败并提供便捷的认证信息更新方式。

## 主要功能

### 1. 自动认证检测
- 自动检测API 401认证失败错误
- 智能重试机制，认证失败时自动尝试刷新
- 详细的日志记录，便于问题排查

### 2. 认证信息缓存管理
- 24小时有效期的认证信息缓存
- 自动检测认证信息是否过期
- 本地JSON文件存储，重启后保持有效

### 3. 多种认证更新方式
- **Web API接口**：通过HTTP POST更新
- **命令行工具**：直接运行Python脚本
- **手动配置**：修改配置文件

## 使用方法

### 方式一：Web API更新（推荐）

当系统检测到认证失败时，可以通过以下API更新：

```bash
curl -X POST http://服务器地址:5001/api/auth/update \
  -H "Content-Type: application/json" \
  -d '{
    "_ams_token": "新的token值",
    "_common_token": "新的token值",
    "HWWAFSESID": "新的session值",
    "HWWAFSESTIME": "新的时间戳"
  }'
```

### 方式二：获取最新认证信息

1. **打开浏览器**，访问 https://platform.inzhiyu.com/
2. **登录账号**（18871627553 / zywl1212）
3. **打开开发者工具**（F12）
4. **切换到Network标签**
5. **刷新页面**或进行任何操作
6. **找到API请求**，右键选择"Copy as cURL"
7. **提取认证信息**：
   ```bash
   # 从cURL命令中提取Cookie信息
   # 例如：Cookie: _ams_token=web_xxx; _common_token=web_xxx; HWWAFSESID=xxx; HWWAFSESTIME=xxx
   ```

### 方式三：命令行更新

```bash
# 进入项目目录
cd /path/to/project

# 运行认证管理器
python3 auth_manager.py

# 或者直接更新
python3 -c "
from auth_manager import update_auth_info
auth_info = {
    '_ams_token': '新的token',
    '_common_token': '新的token',
    'HWWAFSESID': '新的session',
    'HWWAFSESTIME': '新的时间戳'
}
update_auth_info(auth_info)
"
```

## 服务器部署

### 快速部署

```bash
# 1. SSH到服务器
ssh user@47.122.68.192

# 2. 进入项目目录
cd /opt/room-management

# 3. 拉取最新代码
sudo git pull origin main

# 4. 重启服务
sudo systemctl restart room-management

# 5. 检查状态
sudo systemctl status room-management
```

### 认证信息初始化

服务器首次部署时，需要初始化认证信息：

```bash
# 在服务器上运行
python3 -c "
from auth_manager import update_auth_info
current_auth = {
    '_ams_token': 'web_cdpi6hgs9ez80cb8jit3emwv2wuh4uo5',
    '_common_token': 'web_cdpi6hgs9ez80cb8jit3emwv2wuh4uo5',
    'HWWAFSESID': '13733731437c2a43e3',
    'HWWAFSESTIME': '1751861002097'
}
update_auth_info(current_auth)
print('认证信息初始化完成')
"
```

## 系统监控

### 检查认证状态

```bash
# 检查API状态
curl -s "http://服务器地址:5001/api/status" | python3 -m json.tool

# 检查认证缓存
ls -la auth_cache.json
cat auth_cache.json | python3 -m json.tool
```

### 查看日志

```bash
# 查看应用日志
sudo journalctl -u room-management -f

# 查看最近的错误
sudo journalctl -u room-management -p err --since "1 hour ago"
```

## 故障排除

### 常见问题

1. **401认证失败**
   - 检查认证信息是否过期
   - 按照上述方法更新认证信息
   - 重启服务

2. **数据为空**
   - 通常是认证问题导致
   - 更新认证信息后会自动恢复

3. **服务无法启动**
   - 检查端口是否被占用
   - 检查Python依赖是否安装完整
   - 查看详细错误日志

### 日志分析

关键日志信息：
- `认证失败，尝试刷新认证信息...` - 检测到401错误
- `认证信息刷新成功` - 认证更新成功
- `使用缓存的认证信息` - 使用有效缓存
- `认证信息过期或不存在` - 需要手动更新

## 技术架构

### 核心组件

1. **AuthManager** - 认证信息管理器
   - 缓存管理
   - 过期检测
   - 持久化存储

2. **RoomsAPIClient** - API客户端
   - 自动重试机制
   - 认证失败检测
   - 智能认证刷新

3. **Web API** - HTTP接口
   - 认证更新端点
   - 状态检查接口
   - 数据刷新功能

### 文件结构

```
├── auth_manager.py          # 认证管理器
├── auth_cache.json          # 认证信息缓存
├── api_client.py            # API客户端（已修改）
├── app.py                   # Web应用（已修改）
├── auto_auth.py             # 自动认证（Selenium版本）
├── auto_auth_simple.py      # 简化版自动认证
└── update_server.sh         # 服务器更新脚本
```

## 更新历史

- **v1.0** - 基础房间管理系统
- **v1.1** - 添加认证信息管理
- **v1.2** - 智能认证检测和自动刷新
- **v1.3** - Web API认证更新接口
- **v1.4** - 认证信息缓存和过期管理

## 联系方式

如有问题或需要技术支持，请联系系统管理员。 